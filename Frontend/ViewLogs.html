<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Drone Config - IoT Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      .logs-container {
          max-width: 1000px;
          margin: 2rem auto;
          padding: 2rem;
      }
      .logs-section {
          background: white;
          padding: 2rem;
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      .back-btn {
          background: linear-gradient(45deg, #FCB53B, #9b8662);
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          margin-bottom: 2rem;
          text-decoration: none;
          display: inline-block;
      }
      .filter-section {
          display: flex;
          gap: 1rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
      }
      .filter-input {
          padding: 8px 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 0.9rem;
      }
      .filter-input:focus {
          outline: none;
          border-color: #667eea;
      }
      .logs-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 1rem;
      }
      .logs-table th,
      .logs-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #eee;
      }
      .logs-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #333;
      }
      .logs-table tr:hover {
          background: #f8f9fa;
      }
      .status-online {
          color: #28a745;
          font-weight: 600;
      }
      .status-offline {
          color: #dc3545;
          font-weight: 600;
      }
      .pagination {
          display: flex;
          justify-content: center;
          gap: 0.5rem;
          margin-top: 2rem;
      }
      .page-btn {
          padding: 8px 12px;
          border: 1px solid #ddd;
          background: white;
          cursor: pointer;
          border-radius: 4px;
      }
      .page-btn:hover {
          background: #f8f9fa;
      }
      .page-btn.active {
          background: #667eea;
          color: white;
          border-color: #667eea;
      }
  </style>
  </style>
</head>
<body>
  <header class="nav-bar">
    <ul class="nav-list">
      <li style="font-size: xx-large;">Iot Website</li>
      <li><a href="index.html">Home</a></li>
      <li><a href="ViewConfig.html">View Config</a></li>
      <li><a href="TLF.html">Temperature Log Form</a></li>
      <li><a href="ViewLogs.html" class="active">View Logs</a></li>
    </ul>
  </header>
  <div class="shooting-star"></div>
<div class="shooting-star"></div>
<div class="shooting-star"></div>
<div class="shooting-star"></div>
<div class="shooting-star"></div>
  <div class="logs-container">
      <a href="index.html" class="back-btn font">← Back to Dashboard</a>
      
            <h1 style="color: #ddd; font-size: 40px; font-weight: 900; font-family: 'Pacifico', cursive;">ViewLogs</h1>
      
            <div class="logs-section">


                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Created</th>
                                <th>Country</th>
                                <th>Drone ID</th>
                                <th>Drone Name</th>
                                <th>Celsius</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody"></tbody>
                    </table>
                    </table>

                    <div id="logsStatus" style="padding: 8px 0; color: #333;"></div>

                    <div class="pagination" id="paginationControls" style="margin-top:16px"></div>
            
                </div>
    </div>
<script>
    (async function(){ 
       
        let APP_DRONE_ID; 

      
        try {
            console.log('ViewLogs: Fetching app config...');
          
            const configRes = await fetch('/api/config'); 
            if (!configRes.ok) {
                throw new Error('Failed to load app config');
            }
            const appConfig = await configRes.json();
            APP_DRONE_ID = appConfig.droneId;
            console.log('ViewLogs: Config loaded. DRONE_ID =', APP_DRONE_ID);
        } catch (e) {
            console.error(e);
            document.body.innerHTML = '<h1>Error: Failed to load app configuration. Please check the server.</h1>';
            return;
        }

      
        const droneIdInput = document.getElementById('droneIdInput');
        const loadBtn = document.getElementById('loadLogsBtn');
        const statusEl = document.getElementById('logsStatus'); 
        const tableBody = document.getElementById('logsTableBody');
        const paginationEl = document.getElementById('paginationControls');

        let clientPage = 1;
        let currentDroneId = droneIdInput && droneIdInput.placeholder || APP_DRONE_ID;
        
       
        const BACKEND_PERPAGE = 5; 
        const CLIENT_PAGE_SIZE = 5; 
        const BACKEND_PAGES_PER_CLIENT = Math.ceil(CLIENT_PAGE_SIZE / BACKEND_PERPAGE); 

     
        function setStatus(text, isError){
            if(!statusEl) return;
            statusEl.textContent = text || '';
            statusEl.style.color = isError ? '#c00' : '#333';
        }
        function formatCreated(created){
            if(!created) return '-';
            const d = new Date(created);
            if(isNaN(d)) return d.toLocaleString();
            return d.toLocaleString();
        }
        async function fetchBackendPage(droneId, backendPage){
            
            const url = `/logs/${encodeURIComponent(droneId)}?page=${backendPage}`; 
            const res = await fetch(url);
            if(!res.ok) throw new Error('Failed to fetch logs: ' + res.status);
            return res.json();
        }
        async function fetchClientPage(droneId, clientPage){
            const backendStart = (clientPage - 1) * BACKEND_PAGES_PER_CLIENT + 1;
            const backendEnd = clientPage * BACKEND_PAGES_PER_CLIENT;
            let allItems = [];
            let totalBackendPages = 0;
            let totalBackendItems = 0; 
            for(let p = backendStart; p <= backendEnd; p++){
            try{
                const body = await fetchBackendPage(droneId, p);
                const items = body && body.data ? body.data : [];
                const pagination = body && body.pagination ? body.pagination : null;
                if(pagination) {
                    if (pagination.totalPages) totalBackendPages = pagination.totalPages;
                    if (pagination.totalItems) totalBackendItems = pagination.totalItems;
                }
                allItems = allItems.concat(items);
                if(allItems.length >= CLIENT_PAGE_SIZE) break;
                if(items.length < BACKEND_PERPAGE) break;
            }catch(err){
                console.error('Error fetching backend page', p, err);
                throw err;
            }
            }
  T-T-T     const trimmed = allItems.slice(0, CLIENT_PAGE_SIZE);
            const clientTotalPages = totalBackendItems ? Math.max(1, Math.ceil(totalBackendItems / CLIENT_PAGE_SIZE)) : 1;
            return { items: trimmed, clientTotalPages, totalBackendItems };
        }
        function renderTable(items){
            if(!tableBody) return;
            tableBody.innerHTML = '';
            if(!items || items.length === 0){
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 5;
            td.textContent = 'No logs';
            tr.appendChild(td);
            tableBody.appendChild(tr);
            return;
            }
            items.forEach(it => {
            const tr = document.createElement('tr');
            const createdTd = document.createElement('td'); createdTd.textContent = formatCreated(it.created || it.createdAt || it.created_date || it.created_at);
            const countryTd = document.createElement('td'); countryTd.textContent = it.country || '-';
            const idTd = document.createElement('td'); idTd.textContent = it.drone_id || (it.drone && it.drone.id) || '-';
            const nameTd = document.createElement('td'); nameTd.textContent = it.drone_name || it.drone_name || '-';
            const celsiusTd = document.createElement('td'); celsiusTd.textContent = (it.celsius !== undefined && it.celsius !== null) ? it.celsius : '-';
            tr.appendChild(createdTd);
            tr.appendChild(countryTd);
            tr.appendChild(idTd);
            tr.appendChild(nameTd);
            tr.appendChild(celsiusTd);
            tableBody.appendChild(tr);
            });
        }
        function renderPagination(current, total){
            if(!paginationEl) return;
            paginationEl.innerHTML = '';
            const prev = document.createElement('button');
            prev.className = 'page-btn';
            prev.textContent = 'Prev';
            prev.disabled = current <= 1;
            prev.addEventListener('click', () => {
            if(current > 1){ clientPage = current - 1; loadAndRender(currentDroneId, clientPage); }
            });
            paginationEl.appendChild(prev);
            const info = document.createElement('div');
           info.style.padding = '8px 12px';
            info.textContent = `Page ${current} of ${total}`;
            paginationEl.appendChild(info);
            const next = document.createElement('button');
            next.className = 'page-btn';
            next.textContent = 'Next';
            next.disabled = current >= total;
            next.addEventListener('click', () => {
            if(current < total){ clientPage = current + 1; loadAndRender(currentDroneId, clientPage); }
            });
            paginationEl.appendChild(next);
        }
        async function loadAndRender(droneId, page){
            setStatus('Loading...');
            try{
                const { items, clientTotalPages, totalBackendItems } = await fetchClientPage(droneId, page);
                renderTable(items);
                renderPagination(page, clientTotalPages);
                setStatus(''); 
            }catch(err){
                console.error(err);
                setStatus('Failed to load logs', true);
                renderTable([]);
                renderPagination(1,1);
            }
        }

       

      
        if(droneIdInput) droneIdInput.value = droneIdInput.placeholder || APP_DRONE_ID;
        currentDroneId = droneIdInput && (droneIdInput.value || droneIdInput.placeholder) || APP_DRONE_ID;
        
        loadAndRender(currentDroneId, clientPage);

    })(); 
</script>



                    <div class="pagination" id="paginationControls" style="margin-top:16px"></div>
          
            </div>
  </div>

  
</body>
</html>
